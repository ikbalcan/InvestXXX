"""
Hisse Avcƒ±sƒ± Tab - Toplu Analiz ve Kar≈üƒ±la≈ütƒ±rma Sistemi
"""

import streamlit as st
import pandas as pd
import numpy as np
import plotly.express as px
import plotly.graph_objects as go
from plotly.subplots import make_subplots
import sys
import os
from datetime import datetime, timedelta
import concurrent.futures
import time
import threading

# Proje mod√ºllerini import et
sys.path.append(os.path.join(os.path.dirname(__file__), 'src'))
sys.path.append(os.path.dirname(__file__))

from data_loader import DataLoader
from feature_engineering import FeatureEngineer
from model_train import StockDirectionPredictor
from price_target_predictor import PriceTargetPredictor
from dashboard_utils import load_config, load_stock_data

@st.cache_data(ttl=300)  # 5 dakika cache
def load_stock_data_cached(symbol, period="1y"):
    """Hisse verilerini cache'li olarak y√ºkle"""
    try:
        return load_stock_data(symbol, period)
    except Exception as e:
        st.error(f"‚ùå {symbol} verisi y√ºklenemedi: {str(e)}")
        return pd.DataFrame()


def analyze_single_stock(symbol, config, period="1y"):
    """Tek hisse analizi - Thread-safe"""
    try:
        # Veri y√ºkle
        data = load_stock_data_cached(symbol, period)
        if data.empty:
            return None
        
        # √ñzellikler olu≈ütur
        try:
            engineer = FeatureEngineer(config)
            features_df = engineer.create_all_features(data)
        except Exception as e:
            st.error(f"‚ùå {symbol} √∂zellikler olu≈üturulamadƒ±: {str(e)}")
            return None
        if features_df.empty:
            return None
        
        # Temel metrikler
        current_price = data['close'].iloc[-1]
        price_change_1d = data['close'].pct_change().iloc[-1] * 100
        price_change_1w = ((data['close'].iloc[-1] / data['close'].iloc[-5]) - 1) * 100 if len(data) >= 5 else 0
        price_change_1m = ((data['close'].iloc[-1] / data['close'].iloc[-20]) - 1) * 100 if len(data) >= 20 else 0
        
        # Volatilite
        volatility = data['close'].pct_change().std() * np.sqrt(252) * 100
        
        # Hacim analizi
        avg_volume = data['volume'].tail(20).mean()
        current_volume = data['volume'].iloc[-1]
        volume_ratio = current_volume / avg_volume if avg_volume > 0 else 1
        
        # Teknik g√∂stergeler
        rsi = features_df['rsi'].iloc[-1] if 'rsi' in features_df.columns else 50
        macd = features_df['macd'].iloc[-1] if 'macd' in features_df.columns else 0
        macd_signal = features_df['macd_signal'].iloc[-1] if 'macd_signal' in features_df.columns else 0
        
        # Trend analizi
        sma_20 = features_df['sma_20'].iloc[-1] if 'sma_20' in features_df.columns else current_price
        sma_50 = features_df['sma_50'].iloc[-1] if 'sma_50' in features_df.columns else current_price
        
        trend_strength = "Y√ºkseli≈ü" if sma_20 > sma_50 else "D√º≈ü√º≈ü"
        
        # Model tahmini (varsa) - AI model √∂ncelikli
        prediction = None
        confidence = None
        price_target = None
        
        # AI model tahmini (varsa) - √ñncelik
        try:
            # En uygun modeli bul
            model_files = []
            if os.path.exists('src/models'):
                model_files = [f for f in os.listdir('src/models') if f.endswith('.joblib')]
            
            symbol_name = symbol.replace('.IS', '')
            symbol_models = [f for f in model_files if symbol_name in f]
            
            if symbol_models:
                # En son modeli se√ß
                symbol_models.sort(reverse=True)
                selected_model = symbol_models[0]
                
                # Modeli y√ºkle ve tahmin yap
                predictor = StockDirectionPredictor(config)
                model_path = f'src/models/{selected_model}'
                
                if predictor.load_model(model_path):
                    # prepare_data otomatik olarak hedef deƒüi≈ükenleri filtreler
                    X, y = predictor.prepare_data(features_df)
                    predictions, probabilities = predictor.predict(X)
                    
                    # AI model tahmini
                    prediction = predictions[-1]
                    confidence = np.max(probabilities[-1])
                    
                    # Hedef fiyat hesapla
                    price_predictor = PriceTargetPredictor(config)
                    price_targets = price_predictor.calculate_price_targets(
                        current_price, prediction, confidence, volatility/100, data, {}
                    )
                    price_target = price_targets['targets']['moderate']
        
        except Exception as e:
            # Model tahmini ba≈üarƒ±sƒ±z olursa teknik analiz kullan
            technical_confidence = 0
            
            # RSI sinyali
            if rsi < 30:
                technical_confidence += 0.3
            elif rsi > 70:
                technical_confidence -= 0.2
            
            # MACD sinyali
            if macd > macd_signal:
                technical_confidence += 0.2
            else:
                technical_confidence -= 0.1
            
            # Trend sinyali
            if trend_strength == "Y√ºkseli≈ü":
                technical_confidence += 0.2
            else:
                technical_confidence -= 0.1
            
            # Momentum sinyali
            if price_change_1w > 5:
                technical_confidence += 0.2
            elif price_change_1w < -5:
                technical_confidence -= 0.2
            
            # Hacim sinyali
            if volume_ratio > 1.5:
                technical_confidence += 0.1
            elif volume_ratio < 0.5:
                technical_confidence -= 0.1
            
            # Teknik analiz bazlƒ± tahmin
            if technical_confidence > 0.4:
                prediction = 1  # AL
                confidence = min(0.8, abs(technical_confidence))
            elif technical_confidence < -0.4:
                prediction = 0  # SAT
                confidence = min(0.8, abs(technical_confidence))
            else:
                prediction = None
                confidence = 0.5
            
            # Hedef fiyat hesapla (teknik analiz bazlƒ±)
            if prediction is not None:
                if prediction == 1:  # AL sinyali
                    price_target = current_price * (1 + (confidence * 0.1))
                else:  # SAT sinyali
                    price_target = current_price * (1 - (confidence * 0.1))
        
        return {
            'symbol': symbol,
            'current_price': current_price,
            'price_change_1d': price_change_1d,
            'price_change_1w': price_change_1w,
            'price_change_1m': price_change_1m,
            'volatility': volatility,
            'volume_ratio': volume_ratio,
            'rsi': rsi,
            'macd': macd,
            'macd_signal': macd_signal,
            'trend_strength': trend_strength,
            'prediction': prediction,
            'confidence': confidence,
            'price_target': price_target,
            'data_points': len(data)
        }
        
    except Exception as e:
        st.error(f"‚ùå {symbol} analizi ba≈üarƒ±sƒ±z: {str(e)}")
        return None

def train_model_for_symbol(symbol, config, progress_callback=None):
    """Tek hisse i√ßin model eƒüitimi"""
    try:
        if progress_callback:
            progress_callback(f"üìä {symbol} verisi y√ºkleniyor...")
        
        # Veri y√ºkle
        data = load_stock_data(symbol, "2y")
        if data.empty:
            return False, f"{symbol} verisi y√ºklenemedi"
        
        if progress_callback:
            progress_callback(f"üîß {symbol} √∂zellikler olu≈üturuluyor...")
        
        # √ñzellikler olu≈ütur
        try:
            engineer = FeatureEngineer(config)
            features_df = engineer.create_all_features(data)
        except Exception as e:
            return False, f"{symbol} √∂zellikler olu≈üturulamadƒ±: {str(e)}"
        
        if features_df.empty:
            return False, f"{symbol} √∂zellikler olu≈üturulamadƒ±"
        
        if progress_callback:
            progress_callback(f"ü§ñ {symbol} model eƒüitiliyor...")
        
        # Model eƒüit
        predictor = StockDirectionPredictor(config)
        X, y = predictor.prepare_data(features_df)
        
        if len(X) < 100:  # Yeterli veri yok
            return False, f"{symbol} yeterli veri yok ({len(X)} g√ºn)"
        
        # Model eƒüitimi
        results = predictor.train_model(X, y)
        
        if progress_callback:
            progress_callback(f"üíæ {symbol} model kaydediliyor...")
        
        # Modeli kaydet
        symbol_name = symbol.replace('.IS', '')
        timestamp = datetime.now().strftime("%Y%m%d_%H%M%S")
        filename = f"{symbol_name}_Model_{timestamp}.joblib"
        
        model_path = predictor.save_model(filename)
        
        if progress_callback:
            progress_callback(f"‚úÖ {symbol} model eƒüitimi tamamlandƒ±!")
        
        return True, f"{symbol} model eƒüitildi - Accuracy: {results['test_metrics']['accuracy']:.3f}"
        
    except Exception as e:
        return False, f"{symbol} model eƒüitimi ba≈üarƒ±sƒ±z: {str(e)}"

def train_models_batch(symbols, config, progress_container):
    """Toplu model eƒüitimi - Progress bar ile"""
    results = []
    total_symbols = len(symbols)
    
    # Progress bar olu≈ütur
    progress_bar = progress_container.progress(0)
    status_text = progress_container.empty()
    
    for i, symbol in enumerate(symbols):
        # Progress g√ºncelle
        progress = (i + 1) / total_symbols
        progress_bar.progress(progress)
        
        # Model eƒüit
        success, message = train_model_for_symbol(symbol, config, status_text.text)
        results.append({
            'symbol': symbol,
            'success': success,
            'message': message
        })
        
        # Kƒ±sa bekleme
        time.sleep(0.1)
    
    return results

def analyze_multiple_stocks(symbols, config, max_workers=5):
    """√áoklu hisse analizi - Paralel i≈ülem"""
    results = []
    
    with st.spinner(f"üîç {len(symbols)} hisse analiz ediliyor..."):
        with concurrent.futures.ThreadPoolExecutor(max_workers=max_workers) as executor:
            # T√ºm hisseleri paralel olarak analiz et
            future_to_symbol = {
                executor.submit(analyze_single_stock, symbol, config): symbol 
                for symbol in symbols
            }
            
            for future in concurrent.futures.as_completed(future_to_symbol):
                symbol = future_to_symbol[future]
                try:
                    result = future.result()
                    if result is not None:
                        results.append(result)
                except Exception as e:
                    st.error(f"‚ùå {symbol} analizi ba≈üarƒ±sƒ±z: {str(e)}")
    
    return results

def calculate_stock_score(stock_data):
    """Hisse skoru hesapla - AI sinyali √∂ncelikli"""
    score = 0
    weights = {
        'momentum': 0.25,      # Fiyat momentumu
        'volatility': 0.10,    # Volatilite (d√º≈ü√ºk = iyi)
        'volume': 0.10,        # Hacim artƒ±≈üƒ±
        'technical': 0.15,     # Teknik g√∂stergeler
        'prediction': 0.40     # Model tahmini (√∂ncelikli - artƒ±rƒ±ldƒ±)
    }
    
    # AI Sinyal kontrol√º - √ñncelikli!
    prediction = stock_data.get('prediction')
    confidence = stock_data.get('confidence')
    
    # SAT sinyali varsa ve confidence y√ºksekse, skorun b√ºy√ºk bir kƒ±smƒ±nƒ± kes
    if prediction == 0 and confidence is not None and confidence > 0.6:
        # Y√ºksek g√ºvenlilikle SAT sinyali = √ßok d√º≈ü√ºk skor
        return max(0, 30)  # Maksimum 30 puan (diƒüer fakt√∂rlerle)
    
    # Momentum skoru (1 haftalƒ±k ve 1 aylƒ±k performans)
    momentum_score = 0
    
    # 1 haftalƒ±k performans
    weekly_change = stock_data['price_change_1w']
    if weekly_change > 10:
        momentum_score += 50
    elif weekly_change > 5:
        momentum_score += 40
    elif weekly_change > 2:
        momentum_score += 30
    elif weekly_change > 0:
        momentum_score += 20
    elif weekly_change > -2:
        momentum_score += 10
    elif weekly_change > -5:
        momentum_score += 5
    
    # 1 aylƒ±k performans
    monthly_change = stock_data['price_change_1m']
    if monthly_change > 20:
        momentum_score += 50
    elif monthly_change > 10:
        momentum_score += 40
    elif monthly_change > 5:
        momentum_score += 30
    elif monthly_change > 0:
        momentum_score += 20
    elif monthly_change > -5:
        momentum_score += 10
    elif monthly_change > -10:
        momentum_score += 5
    
    score += momentum_score * weights['momentum']
    
    # Volatilite skoru (d√º≈ü√ºk volatilite = y√ºksek skor)
    volatility_score = max(0, 100 - stock_data['volatility'])
    score += volatility_score * weights['volatility']
    
    # Hacim skoru
    volume_score = min(100, stock_data['volume_ratio'] * 50)
    score += volume_score * weights['volume']
    
    # Teknik skoru
    technical_score = 0
    
    # RSI skoru
    if stock_data['rsi'] < 30:  # A≈üƒ±rƒ± satƒ±m - fƒ±rsat
        technical_score += 30
    elif stock_data['rsi'] > 70:  # A≈üƒ±rƒ± alƒ±m - risk
        technical_score += 5
    else:
        technical_score += 20
    
    # MACD skoru
    if stock_data['macd'] > stock_data['macd_signal']:
        technical_score += 30
    else:
        technical_score += 10
    
    # Trend skoru
    if stock_data['trend_strength'] == "Y√ºkseli≈ü":
        technical_score += 20
    else:
        technical_score += 5
    
    score += max(0, technical_score) * weights['technical']
    
    # Model tahmin skoru - En √∂nemli fakt√∂r
    prediction_score = 0
    if prediction is not None and confidence is not None:
        if prediction == 1:  # AL sinyali
            prediction_score = confidence * 100  # Y√ºksek puan
        else:  # SAT sinyali
            prediction_score = (1 - confidence) * 10  # √áok d√º≈ü√ºk puan
    
    score += prediction_score * weights['prediction']
    
    # Final kontrol: SAT sinyali varsa skoru kƒ±sƒ±tla
    if prediction == 0:
        return min(40, score)  # SAT sinyali i√ßin maksimum 40 puan
    
    return min(100, max(0, score))

def create_stock_comparison_chart(results_df):
    """Hisse kar≈üƒ±la≈ütƒ±rma grafiƒüi"""
    fig = make_subplots(
        rows=2, cols=2,
        subplot_titles=(
            'Son 1 Haftalƒ±k Fiyat Performansƒ± (%)', 
            'Fiyat Dalgalanmasƒ± - Risk Seviyesi (%)', 
            'ƒ∞≈ülem Hacmi (G√ºnl√ºk/Ortalama)', 
            'RSI G√∂stergesi - A≈üƒ±rƒ± Alƒ±m/Satƒ±m'
        ),
        specs=[[{"secondary_y": False}, {"secondary_y": False}],
               [{"secondary_y": False}, {"secondary_y": False}]]
    )
    
    # 1 haftalƒ±k fiyat deƒüi≈üimi
    fig.add_trace(
        go.Bar(x=results_df['symbol'], y=results_df['price_change_1w'], 
               name='1 Hafta Performansƒ±', marker_color='lightblue',
               hovertemplate='<b>%{x}</b><br>1 Haftalƒ±k Deƒüi≈üim: %{y:.2f}%<extra></extra>'),
        row=1, col=1
    )
    
    # Volatilite (Risk seviyesi)
    fig.add_trace(
        go.Bar(x=results_df['symbol'], y=results_df['volatility'], 
               name='Fiyat Dalgalanmasƒ±', marker_color='orange',
               hovertemplate='<b>%{x}</b><br>Risk Seviyesi: %{y:.2f}%<br><i>D√º≈ü√ºk = Kararlƒ±, Y√ºksek = Riskli</i><extra></extra>'),
        row=1, col=2
    )
    
    # Hacim oranƒ± (G√ºnl√ºk/ortalama)
    fig.add_trace(
        go.Bar(x=results_df['symbol'], y=results_df['volume_ratio'], 
               name='Hacim Oranƒ±', marker_color='green',
               hovertemplate='<b>%{x}</b><br>G√ºnl√ºk/Ortalama: %{y:.2f}x<br><i>1x = Normal, &gt;1.5x = ƒ∞lgi Artƒ±≈üƒ±</i><extra></extra>'),
        row=2, col=1
    )
    
    # RSI g√∂stergesi
    fig.add_trace(
        go.Bar(x=results_df['symbol'], y=results_df['rsi'], 
               name='RSI', marker_color='red',
               hovertemplate='<b>%{x}</b><br>RSI: %{y:.1f}<br><i>&lt;30 = A≈üƒ±rƒ± Satƒ±m, &gt;70 = A≈üƒ±rƒ± Alƒ±m</i><extra></extra>'),
        row=2, col=2
    )
    
    # Y ekseni ba≈ülƒ±klarƒ±nƒ± g√ºncelle
    fig.update_yaxes(title_text="Deƒüi≈üim (%)", row=1, col=1)
    fig.update_yaxes(title_text="Volatilite (%)", row=1, col=2)
    fig.update_yaxes(title_text="Hacim Oranƒ±", row=2, col=1)
    fig.update_yaxes(title_text="RSI Deƒüeri", row=2, col=2)
    
    fig.update_layout(
        height=600, 
        showlegend=False, 
        title_text="Hisse Kar≈üƒ±la≈ütƒ±rma Analizi",
        hovermode='closest'
    )
    return fig

def show_stock_hunter_tab(bist_stocks, all_symbols, config):
    """Hisse Avcƒ±sƒ± Tab"""
    
    st.markdown('<h2 class="section-title">üéØ Hisse Avcƒ±sƒ± - BIST Avƒ±</h2>', unsafe_allow_html=True)
    
    st.info("""
    üîç **Hisse Avcƒ±sƒ± Nedir?**
    
    Bu sekme ile birden fazla hisseyi aynƒ± anda analiz edebilir, kar≈üƒ±la≈ütƒ±rabilir ve 
    en iyi fƒ±rsatlarƒ± bulabilirsiniz. Sistem hisseleri √ße≈üitli kriterlere g√∂re sƒ±ralar:
    
    - üìà **Getiri Potansiyeli**: En y√ºksek y√ºkseli≈ü potansiyeli olan hisseler
    - üå™Ô∏è **Volatilite Analizi**: Y√ºksek volatilite ama pozitif g√∂r√ºnen hisseler  
    - üéØ **Teknik Sinyaller**: G√º√ßl√º teknik analiz sinyalleri veren hisseler
    - ü§ñ **AI Tahminleri**: Model tahminleri en g√ºvenilir olan hisseler
    """)
    
    # Se√ßim y√∂ntemi
    st.markdown("### üéØ Analiz Stratejisi")
    
    col1, col2 = st.columns(2)
    
    with col1:
        analysis_type = st.selectbox(
            "Analiz T√ºr√º:",
            ["üèÜ En ƒ∞yi Fƒ±rsatlar", "üå™Ô∏è Y√ºksek Volatilite", "üìà Momentum Avcƒ±sƒ±", "ü§ñ AI Destekli"],
            help="Hangi kriterlere g√∂re hisse arayacaƒüƒ±nƒ±zƒ± se√ßin"
        )
    
    with col2:
        max_stocks = st.slider(
            "Maksimum Hisse Sayƒ±sƒ±:",
            min_value=5, max_value=50, value=20,
            help="Analiz edilecek maksimum hisse sayƒ±sƒ±"
        )
    
    # Otomatik model eƒüitimi se√ßeneƒüi
    st.markdown("### ü§ñ Model Y√∂netimi")
    
    col1, col2, col3 = st.columns(3)
    
    with col1:
        auto_train_models = st.checkbox(
            "üîÑ Otomatik Model Eƒüitimi",
            value=False,
            help="Eƒüitilmi≈ü model yoksa otomatik eƒüit"
        )
    
    with col2:
        update_existing_models = st.checkbox(
            "üîÑ Mevcut Modelleri G√ºncelle",
            value=False,
            help="Eski modelleri yenileriyle deƒüi≈ütir"
        )
    
    with col3:
        if st.button("üßπ Eski Modelleri Temizle", help="7 g√ºnden eski modelleri sil"):
            # Eski modelleri temizle
            if os.path.exists('src/models'):
                model_files = [f for f in os.listdir('src/models') if f.endswith('.joblib')]
                old_models = []
                cutoff_date = datetime.now() - timedelta(days=7)
                
                for model_file in model_files:
                    model_path = f'src/models/{model_file}'
                    if os.path.getctime(model_path) < cutoff_date.timestamp():
                        old_models.append(model_file)
                
                if old_models:
                    for model_file in old_models:
                        os.remove(f'src/models/{model_file}')
                    st.success(f"‚úÖ {len(old_models)} eski model temizlendi!")
                else:
                    st.info("‚ÑπÔ∏è Temizlenecek eski model bulunamadƒ±.")
            else:
                st.warning("‚ö†Ô∏è Model klas√∂r√º bulunamadƒ±.")
    
    # Hisse se√ßimi
    st.markdown("### üìä Analiz Edilecek Hisseler")
    
    selection_method = st.radio(
        "Hisse Se√ßim Y√∂ntemi:",
        ["üéØ Sekt√∂rel Analiz", "üìã Manuel Se√ßim", "üèÜ Pop√ºler Hisseler"],
        horizontal=True
    )
    
    selected_symbols = []
    
    if selection_method == "üéØ Sekt√∂rel Analiz":
        # Sekt√∂r se√ßimi
        selected_categories = st.multiselect(
            "Analiz Edilecek Sekt√∂rler:",
            list(bist_stocks.keys()),
            default=list(bist_stocks.keys())[:3],
            help="Hangi sekt√∂rlerden hisse analiz etmek istiyorsunuz?"
        )
        
        if selected_categories:
            for category in selected_categories:
                selected_symbols.extend(bist_stocks[category])
            
            # Maksimum sayƒ±ya g√∂re sƒ±nƒ±rla
            if len(selected_symbols) > max_stocks:
                selected_symbols = selected_symbols[:max_stocks]
    
    elif selection_method == "üìã Manuel Se√ßim":
        # Manuel se√ßim
        selected_symbols = st.multiselect(
            "Analiz Edilecek Hisseler:",
            all_symbols,
            default=all_symbols[:10],
            help="Analiz etmek istediƒüiniz hisseleri se√ßin"
        )
    
    else:  # Pop√ºler Hisseler
        # Pop√ºler hisseler
        popular_stocks = ['THYAO.IS', 'AKBNK.IS', 'BIMAS.IS', 'GARAN.IS', 'ASELS.IS', 
                         'EREGL.IS', 'SAHOL.IS', 'TUPRS.IS', 'PETKM.IS', 'KRDMD.IS',
                         'FROTO.IS', 'ULKER.IS', 'MGROS.IS', 'OTKAR.IS', 'TKFEN.IS']
        
        selected_symbols = st.multiselect(
            "Pop√ºler Hisseler:",
            popular_stocks,
            default=popular_stocks[:10],
            help="BIST'teki pop√ºler hisselerden se√ßim yapƒ±n"
        )
    
    # Analiz butonu
    if selected_symbols and len(selected_symbols) > 0:
        st.markdown(f"**üìä Se√ßilen Hisse Sayƒ±sƒ±:** {len(selected_symbols)}")
        
        if st.button("üöÄ Analizi Ba≈ülat", type="primary"):
            # Otomatik model eƒüitimi kontrol√º
            if auto_train_models or update_existing_models:
                st.markdown("### ü§ñ Model Durumu Kontrol Ediliyor...")
                
                # Model durumunu kontrol et
                symbols_without_models = []
                symbols_to_update = []
                
                if os.path.exists('src/models'):
                    model_files = [f for f in os.listdir('src/models') if f.endswith('.joblib')]
                    existing_models = {f.split('_')[0]: f for f in model_files}
                else:
                    existing_models = {}
                
                for symbol in selected_symbols:
                    symbol_name = symbol.replace('.IS', '')
                    
                    if symbol_name not in existing_models:
                        symbols_without_models.append(symbol)
                    elif update_existing_models:
                        symbols_to_update.append(symbol)
                
                # Model eƒüitimi gereken hisseler
                symbols_to_train = symbols_without_models + symbols_to_update
                
                if symbols_to_train:
                    st.info(f"üîÑ {len(symbols_to_train)} hisse i√ßin model eƒüitimi ba≈ülatƒ±lƒ±yor...")
                    
                    # Progress container olu≈ütur
                    progress_container = st.container()
                    
                    # Model eƒüitimi ba≈ülat
                    training_results = train_models_batch(symbols_to_train, config, progress_container)
                    
                    # Sonu√ßlarƒ± g√∂ster
                    successful_trainings = [r for r in training_results if r['success']]
                    failed_trainings = [r for r in training_results if not r['success']]
                    
                    if successful_trainings:
                        st.success(f"‚úÖ {len(successful_trainings)} model ba≈üarƒ±yla eƒüitildi!")
                        for result in successful_trainings:
                            st.write(f"‚Ä¢ {result['message']}")
                    
                    if failed_trainings:
                        st.warning(f"‚ö†Ô∏è {len(failed_trainings)} model eƒüitimi ba≈üarƒ±sƒ±z:")
                        for result in failed_trainings:
                            st.write(f"‚Ä¢ {result['message']}")
                    
                    st.markdown("---")
                
                else:
                    st.success("‚úÖ T√ºm hisseler i√ßin g√ºncel modeller mevcut!")
            
            # Analizi ba≈ülat
            results = analyze_multiple_stocks(selected_symbols, config)
            
            if results:
                # DataFrame olu≈ütur
                results_df = pd.DataFrame(results)
                
                # None deƒüerleri temizle ve g√ºvenli hale getir
                results_df['prediction'] = results_df['prediction'].where(pd.notna(results_df['prediction']), None)
                results_df['confidence'] = results_df['confidence'].where(pd.notna(results_df['confidence']), None)
                results_df['price_target'] = results_df['price_target'].where(pd.notna(results_df['price_target']), None)
                
                # Skor hesapla
                results_df['score'] = results_df.apply(calculate_stock_score, axis=1)
                
                # Analiz t√ºr√ºne g√∂re sƒ±rala
                if analysis_type == "üèÜ En ƒ∞yi Fƒ±rsatlar":
                    results_df = results_df.sort_values('score', ascending=False)
                elif analysis_type == "üå™Ô∏è Y√ºksek Volatilite":
                    results_df = results_df.sort_values('volatility', ascending=False)
                elif analysis_type == "üìà Momentum Avcƒ±sƒ±":
                    results_df = results_df.sort_values('price_change_1w', ascending=False)
                elif analysis_type == "ü§ñ AI Destekli":
                    # Model tahmini olan hisseleri √∂ncele
                    results_df = results_df.sort_values(['confidence', 'score'], ascending=[False, False])
                
                # Sonu√ßlarƒ± g√∂ster
                st.markdown("---")
                st.markdown("### üèÜ Analiz Sonu√ßlarƒ±")
                
                # √ñzet metrikler
                col1, col2, col3, col4 = st.columns(4)
                
                with col1:
                    avg_score = results_df['score'].mean()
                    st.metric("Ortalama Skor", f"{avg_score:.1f}")
                
                with col2:
                    buy_signals = len(results_df[results_df['prediction'] == 1])
                    st.metric("üü¢ AL Sinyali", f"{buy_signals}/{len(results_df)}")
                
                with col3:
                    high_conf_stocks = len(results_df[(results_df['confidence'] >= 0.7)])
                    st.metric("Y√ºksek G√ºven", f"{high_conf_stocks}/{len(results_df)}")
                
                with col4:
                    low_risk_stocks = len(results_df[results_df['volatility'] < 30])
                    st.metric("D√º≈ü√ºk Risk", f"{low_risk_stocks}/{len(results_df)}")
                
                # Filtreleme se√ßenekleri
                st.markdown("### üîç Filtreleme Se√ßenekleri")
                filter_col1, filter_col2, filter_col3 = st.columns(3)
                
                with filter_col1:
                    show_only = st.selectbox(
                        "G√∂ster:",
                        ["T√ºm√º", "üü¢ Sadece AL", "üî¥ Sadece SAT", "üü¢ Y√ºksek Skor (>60)", "üü° Orta Skor (40-60)", "üî¥ D√º≈ü√ºk Skor (<40)"],
                        key="filter_show"
                    )
                
                with filter_col2:
                    risk_level = st.selectbox(
                        "Risk Seviyesi:",
                        ["T√ºm√º", "üü¢ D√º≈ü√ºk (<30%)", "üü° Orta (30-50%)", "üî¥ Y√ºksek (>50%)"],
                        key="filter_risk"
                    )
                
                with filter_col3:
                    confidence_level = st.selectbox(
                        "G√ºven Seviyesi:",
                        ["T√ºm√º", "üü¢ √áok Y√ºksek (‚â•0.8)", "üü° Y√ºksek (0.6-0.8)", "üî¥ D√º≈ü√ºk (<0.6)"],
                        key="filter_confidence"
                    )
                
                # Filtreleri uygula
                filtered_df = results_df.copy()
                
                if show_only == "üü¢ Sadece AL":
                    filtered_df = filtered_df[filtered_df['prediction'] == 1]
                elif show_only == "üî¥ Sadece SAT":
                    filtered_df = filtered_df[filtered_df['prediction'] == 0]
                elif show_only == "üü¢ Y√ºksek Skor (>60)":
                    filtered_df = filtered_df[filtered_df['score'] > 60]
                elif show_only == "üü° Orta Skor (40-60)":
                    filtered_df = filtered_df[(filtered_df['score'] >= 40) & (filtered_df['score'] <= 60)]
                elif show_only == "üî¥ D√º≈ü√ºk Skor (<40)":
                    filtered_df = filtered_df[filtered_df['score'] < 40]
                
                if risk_level == "üü¢ D√º≈ü√ºk (<30%)":
                    filtered_df = filtered_df[filtered_df['volatility'] < 30]
                elif risk_level == "üü° Orta (30-50%)":
                    filtered_df = filtered_df[(filtered_df['volatility'] >= 30) & (filtered_df['volatility'] < 50)]
                elif risk_level == "üî¥ Y√ºksek (>50%)":
                    filtered_df = filtered_df[filtered_df['volatility'] > 50]
                
                if confidence_level == "üü¢ √áok Y√ºksek (‚â•0.8)":
                    filtered_df = filtered_df[filtered_df['confidence'] >= 0.8]
                elif confidence_level == "üü° Y√ºksek (0.6-0.8)":
                    filtered_df = filtered_df[(filtered_df['confidence'] >= 0.6) & (filtered_df['confidence'] < 0.8)]
                elif confidence_level == "üî¥ D√º≈ü√ºk (<0.6)":
                    filtered_df = filtered_df[filtered_df['confidence'] < 0.6]
                
                # Filtrelenmi≈ü sonu√ß sayƒ±sƒ±
                st.info(f"üìä {len(filtered_df)} hisse listelendi (toplam {len(results_df)})")
                
                # Top 10 hisse tablosu - Dinamik ba≈ülƒ±k
                if len(filtered_df) > 0:
                    avg_score = filtered_df['score'].mean()
                    if avg_score >= 60:
                        table_title = f"### ü•á En ƒ∞yi Hisseler (Skor: {avg_score:.1f})"
                    elif avg_score >= 40:
                        table_title = f"### üìä Analiz Edilen Hisseler (Skor: {avg_score:.1f})"
                    else:
                        table_title = f"### ‚ö†Ô∏è D√º≈ü√ºk Skorlu Hisseler (Skor: {avg_score:.1f})"
                    
                    st.markdown(table_title)
                    
                    # Tablo i√ßin veri hazƒ±rla (filtrelenmi≈ü verilerden)
                    display_df = filtered_df.head(10).copy()
                else:
                    st.warning("‚ö†Ô∏è Se√ßilen filtre kriterlerine uygun hisse bulunamadƒ±!")
                    display_df = pd.DataFrame()
                
                if not display_df.empty:
                    # Kolonlarƒ± hazƒ±rla
                    display_df['Fiyat'] = display_df['current_price'].round(2)
                    display_df['1G√ºn %'] = display_df['price_change_1d'].round(2)
                    display_df['1Hafta %'] = display_df['price_change_1w'].round(2)
                    display_df['1Ay %'] = display_df['price_change_1m'].round(2)
                    display_df['Volatilite %'] = display_df['volatility'].round(1)
                    display_df['Skor'] = display_df['score'].round(1)
                    display_df['RSI'] = display_df['rsi'].round(1)
                    display_df['Trend'] = display_df['trend_strength']
                    
                    # AI tahminleri
                    display_df['AI Sinyal'] = display_df.apply(lambda x: 
                        f"{'üü¢ AL' if x['prediction'] == 1 else 'üî¥ SAT' if x['prediction'] == 0 else '‚ö™ N/A'}", axis=1)
                    
                    # AI G√ºven kategorisi (Y√ºksek g√ºven = iyi)
                    def categorize_confidence(conf):
                        if pd.isna(conf) or conf is None:
                            return "‚ö™ N/A"
                        if conf >= 0.8:
                            return "üü¢ √áok Y√ºksek"
                        elif conf >= 0.6:
                            return "üü° Orta"
                        else:
                            return "üî¥ D√º≈ü√ºk"
                    
                    display_df['AI G√ºven'] = display_df['confidence'].apply(categorize_confidence)
                    
                    # Hedef fiyat
                    display_df['Hedef Fiyat'] = display_df['price_target'].apply(
                        lambda x: f"{x:.2f}" if pd.notna(x) and x is not None else "N/A"
                    )
                    
                    # Risk Kategorisi
                    def categorize_risk(volatility):
                        if volatility > 50:
                            return "üî¥ Y√ºksek"
                        elif volatility > 30:
                            return "üü° Orta"
                        else:
                            return "üü¢ D√º≈ü√ºk"
                    
                    display_df['Risk'] = display_df['volatility'].apply(categorize_risk)
                    
                    # Skor kategorisi
                    def categorize_score(score):
                        if score >= 70:
                            return "üü¢ M√ºkemmel"
                        elif score >= 50:
                            return "üü° ƒ∞yi"
                        else:
                            return "üî¥ Orta"
                    
                    display_df['Skor Kategori'] = display_df['score'].apply(categorize_score)
                    
                    # Tablo g√∂ster
                    table_columns = ['symbol', 'Fiyat', '1Hafta %', 'Skor Kategori', 'Skor', 
                                   'AI Sinyal', 'AI G√ºven', 'Risk', 'RSI', 'Hedef Fiyat']
                    
                    st.dataframe(
                        display_df[table_columns],
                        use_container_width=True,
                        column_config={
                            "symbol": "Hisse",
                            "Fiyat": st.column_config.NumberColumn("Fiyat (TL)", format="%.2f"),
                            "1Hafta %": st.column_config.NumberColumn("1 Hafta %", format="%.2f"),
                            "Skor Kategori": "Kategori",
                            "Skor": st.column_config.NumberColumn("Skor", format="%.1f"),
                            "AI Sinyal": "AI Sinyal",
                            "AI G√ºven": "AI G√ºven",
                            "Risk": "Risk",
                            "RSI": st.column_config.NumberColumn("RSI", format="%.1f"),
                            "Hedef Fiyat": "Hedef (TL)"
                        }
                    )
                    
                    # Grafik analizi
                    st.markdown("### üìä Kar≈üƒ±la≈ütƒ±rma Grafikleri")
                    comparison_chart = create_stock_comparison_chart(filtered_df if len(filtered_df) > 0 else results_df)
                    st.plotly_chart(comparison_chart, use_container_width=True)
                
                # Detaylƒ± analiz
                st.markdown("### üîç Detaylƒ± Analiz")
                
                # En iyi 3 hisse detayƒ±
                top_3 = results_df.head(3)
                
                for i, (_, stock) in enumerate(top_3.iterrows(), 1):
                    with st.expander(f"ü•á #{i} {stock['symbol']} - Skor: {stock['score']:.1f}", expanded=i==1):
                        col1, col2, col3 = st.columns(3)
                        
                        with col1:
                            st.markdown("**üí∞ Fiyat Bilgileri**")
                            st.write(f"G√ºncel Fiyat: {stock['current_price']:.2f} TL")
                            st.write(f"1 G√ºn: {stock['price_change_1d']:+.2f}%")
                            st.write(f"1 Hafta: {stock['price_change_1w']:+.2f}%")
                            st.write(f"1 Ay: {stock['price_change_1m']:+.2f}%")
                        
                        with col2:
                            st.markdown("**üìä Teknik Analiz**")
                            st.write(f"Volatilite: {stock['volatility']:.1f}%")
                            st.write(f"RSI: {stock['rsi']:.1f}")
                            st.write(f"Trend: {stock['trend_strength']}")
                            st.write(f"Hacim Oranƒ±: {stock['volume_ratio']:.2f}x")
                        
                        with col3:
                            st.markdown("**ü§ñ AI Tahmini**")
                            if stock['prediction'] is not None:
                                signal = "üü¢ AL" if stock['prediction'] == 1 else "üî¥ SAT"
                                st.write(f"Sinyal: {signal}")
                                st.write(f"G√ºven: {stock['confidence']:.2f}")
                                if stock['price_target']:
                                    st.write(f"Hedef: {stock['price_target']:.2f} TL")
                            else:
                                st.write("Model tahmini yok")
                
                # Sekt√∂rel daƒüƒ±lƒ±m
                st.markdown("### üè≠ Sekt√∂rel Daƒüƒ±lƒ±m")
                
                # Hangi sekt√∂rden ka√ß hisse var
                sector_counts = {}
                for _, stock in results_df.iterrows():
                    symbol = stock['symbol']
                    for sector, stocks in bist_stocks.items():
                        if symbol in stocks:
                            sector_counts[sector] = sector_counts.get(sector, 0) + 1
                            break
                
                if sector_counts:
                    sector_df = pd.DataFrame(list(sector_counts.items()), columns=['Sekt√∂r', 'Hisse Sayƒ±sƒ±'])
                    fig = px.pie(sector_df, values='Hisse Sayƒ±sƒ±', names='Sekt√∂r', 
                               title="Analiz Edilen Hisselerin Sekt√∂rel Daƒüƒ±lƒ±mƒ±")
                    st.plotly_chart(fig, use_container_width=True)
                
                # Risk analizi
                st.markdown("### ‚ö†Ô∏è Risk Analizi")
                
                col1, col2 = st.columns(2)
                
                with col1:
                    st.markdown("**üå™Ô∏è Volatilite Daƒüƒ±lƒ±mƒ±**")
                    volatility_ranges = {
                        'D√º≈ü√ºk (<20%)': len(results_df[results_df['volatility'] < 20]),
                        'Orta (20-40%)': len(results_df[(results_df['volatility'] >= 20) & (results_df['volatility'] < 40)]),
                        'Y√ºksek (40-60%)': len(results_df[(results_df['volatility'] >= 40) & (results_df['volatility'] < 60)]),
                        '√áok Y√ºksek (>60%)': len(results_df[results_df['volatility'] >= 60])
                    }
                    
                    for range_name, count in volatility_ranges.items():
                        st.write(f"{range_name}: {count} hisse")
                
                with col2:
                    st.markdown("**üìà Performans Daƒüƒ±lƒ±mƒ±**")
                    performance_ranges = {
                        'G√º√ßl√º Y√ºkseli≈ü (>10%)': len(results_df[results_df['price_change_1w'] > 10]),
                        'Y√ºkseli≈ü (0-10%)': len(results_df[(results_df['price_change_1w'] >= 0) & (results_df['price_change_1w'] <= 10)]),
                        'D√º≈ü√º≈ü (0-(-10%))': len(results_df[(results_df['price_change_1w'] >= -10) & (results_df['price_change_1w'] < 0)]),
                        'G√º√ßl√º D√º≈ü√º≈ü (<-10%)': len(results_df[results_df['price_change_1w'] < -10])
                    }
                    
                    for range_name, count in performance_ranges.items():
                        st.write(f"{range_name}: {count} hisse")
                
                # Yatƒ±rƒ±m √∂nerileri
                st.markdown("### üí° Yatƒ±rƒ±m √ñnerileri")
                
                # En iyi fƒ±rsatlar
                best_opportunities = results_df[
                    (results_df['score'] > 70) & 
                    (results_df['price_change_1w'] > 0) & 
                    (results_df['volatility'] < 50)
                ].head(5)
                
                if not best_opportunities.empty:
                    st.success("üéØ **En ƒ∞yi Fƒ±rsatlar** (Y√ºksek skor + Pozitif momentum + D√º≈ü√ºk risk)")
                    for _, stock in best_opportunities.iterrows():
                        st.write(f"‚Ä¢ **{stock['symbol']}**: Skor {stock['score']:.1f}, 1 hafta {stock['price_change_1w']:+.1f}%")
                
                # Y√ºksek volatilite fƒ±rsatlarƒ±
                high_vol_opportunities = results_df[
                    (results_df['volatility'] > 40) & 
                    (results_df['price_change_1w'] > 0) & 
                    (results_df['prediction'] == 1)
                ].head(5)
                
                if not high_vol_opportunities.empty:
                    st.warning("üå™Ô∏è **Y√ºksek Volatilite Fƒ±rsatlarƒ±** (Riskli ama pozitif)")
                    for _, stock in high_vol_opportunities.iterrows():
                        st.write(f"‚Ä¢ **{stock['symbol']}**: Volatilite {stock['volatility']:.1f}%, AI sinyali AL")
                
                # AI destekli √∂neriler
                ai_recommendations = results_df[
                    (results_df['prediction'].notna()) & 
                    (results_df['confidence'] > 0.7)
                ].head(5)
                
                if not ai_recommendations.empty:
                    st.info("ü§ñ **AI Destekli √ñneriler** (Y√ºksek g√ºven skorlu)")
                    for _, stock in ai_recommendations.iterrows():
                        signal = "AL" if stock['prediction'] == 1 else "SAT"
                        st.write(f"‚Ä¢ **{stock['symbol']}**: {signal} sinyali, g√ºven {stock['confidence']:.2f}")
                
                # Teknik analiz √∂nerileri
                technical_buy_signals = results_df[
                    (results_df['rsi'] < 30) & 
                    (results_df['price_change_1w'] > 0) & 
                    (results_df['trend_strength'] == "Y√ºkseli≈ü")
                ].head(5)
                
                if not technical_buy_signals.empty:
                    st.success("üìà **Teknik Analiz AL Sinyalleri** (RSI A≈üƒ±rƒ± Satƒ±m + Y√ºkseli≈ü)")
                    for _, stock in technical_buy_signals.iterrows():
                        st.write(f"‚Ä¢ **{stock['symbol']}**: RSI {stock['rsi']:.1f}, Trend {stock['trend_strength']}")
                
                # Momentum fƒ±rsatlarƒ±
                momentum_opportunities = results_df[
                    (results_df['price_change_1w'] > 10) & 
                    (results_df['volume_ratio'] > 1.5) & 
                    (results_df['volatility'] < 60)
                ].head(5)
                
                if not momentum_opportunities.empty:
                    st.info("üöÄ **Momentum Fƒ±rsatlarƒ±** (G√º√ßl√º y√ºkseli≈ü + Y√ºksek hacim)")
                    for _, stock in momentum_opportunities.iterrows():
                        st.write(f"‚Ä¢ **{stock['symbol']}**: 1 hafta {stock['price_change_1w']:+.1f}%, Hacim {stock['volume_ratio']:.1f}x")
                
                # D√º≈ü√ºk riskli fƒ±rsatlar
                low_risk_opportunities = results_df[
                    (results_df['volatility'] < 25) & 
                    (results_df['price_change_1w'] > 0) & 
                    (results_df['score'] > 60)
                ].head(5)
                
                if not low_risk_opportunities.empty:
                    st.success("üõ°Ô∏è **D√º≈ü√ºk Riskli Fƒ±rsatlar** (D√º≈ü√ºk volatilite + Pozitif)")
                    for _, stock in low_risk_opportunities.iterrows():
                        st.write(f"‚Ä¢ **{stock['symbol']}**: Volatilite {stock['volatility']:.1f}%, Skor {stock['score']:.1f}")
                
                # Sekt√∂rel √∂neriler
                st.markdown("### üè≠ Sekt√∂rel √ñneriler")
                
                sector_recommendations = {}
                for _, stock in results_df.iterrows():
                    symbol = stock['symbol']
                    for sector, stocks in bist_stocks.items():
                        if symbol in stocks:
                            if sector not in sector_recommendations:
                                sector_recommendations[sector] = []
                            sector_recommendations[sector].append(stock)
                            break
                
                # Her sekt√∂r i√ßin en iyi hisseyi √∂ner
                for sector, stocks in sector_recommendations.items():
                    if stocks:
                        best_stock = max(stocks, key=lambda x: x['score'])
                        if best_stock['score'] > 60:
                            signal_emoji = "üü¢" if best_stock['prediction'] == 1 else "üî¥" if best_stock['prediction'] == 0 else "‚ö™"
                            st.write(f"**{sector}**: {signal_emoji} **{best_stock['symbol']}** - Skor: {best_stock['score']:.1f}")
                
                # Risk uyarƒ±larƒ±
                st.markdown("### ‚ö†Ô∏è Risk Uyarƒ±larƒ±")
                
                high_risk_stocks = results_df[
                    (results_df['volatility'] > 60) & 
                    (results_df['price_change_1w'] < -5)
                ].head(3)
                
                if not high_risk_stocks.empty:
                    st.error("üö® **Y√ºksek Riskli Hisseler** (Y√ºksek volatilite + D√º≈ü√º≈ü)")
                    for _, stock in high_risk_stocks.iterrows():
                        st.write(f"‚Ä¢ **{stock['symbol']}**: Volatilite {stock['volatility']:.1f}%, 1 hafta {stock['price_change_1w']:+.1f}%")
                
                # Genel piyasa durumu
                st.markdown("### üìä Genel Piyasa Durumu")
                
                positive_count = len(results_df[results_df['price_change_1w'] > 0])
                total_count = len(results_df)
                positive_ratio = positive_count / total_count if total_count > 0 else 0
                
                col1, col2, col3 = st.columns(3)
                
                with col1:
                    if positive_ratio > 0.6:
                        st.success(f"üìà **Piyasa Durumu: Pozitif** ({positive_count}/{total_count})")
                    elif positive_ratio > 0.4:
                        st.warning(f"‚öñÔ∏è **Piyasa Durumu: Karƒ±≈üƒ±k** ({positive_count}/{total_count})")
                    else:
                        st.error(f"üìâ **Piyasa Durumu: Negatif** ({positive_count}/{total_count})")
                
                with col2:
                    avg_volatility = results_df['volatility'].mean()
                    if avg_volatility < 30:
                        st.success(f"üõ°Ô∏è **Volatilite: D√º≈ü√ºk** ({avg_volatility:.1f}%)")
                    elif avg_volatility < 50:
                        st.warning(f"‚ö†Ô∏è **Volatilite: Orta** ({avg_volatility:.1f}%)")
                    else:
                        st.error(f"üå™Ô∏è **Volatilite: Y√ºksek** ({avg_volatility:.1f}%)")
                
                with col3:
                    ai_signals_count = len(results_df[results_df['prediction'].notna()])
                    if ai_signals_count > 0:
                        ai_buy_count = len(results_df[results_df['prediction'] == 1])
                        ai_sell_count = len(results_df[results_df['prediction'] == 0])
                        st.info(f"ü§ñ **AI Sinyalleri**: {ai_buy_count} AL, {ai_sell_count} SAT")
                    else:
                        st.info("ü§ñ **AI Sinyalleri**: Teknik analiz bazlƒ±")
                
            else:
                st.error("‚ùå Analiz sonucu bulunamadƒ±!")
    
    else:
        st.warning("‚ö†Ô∏è L√ºtfen analiz edilecek hisseleri se√ßin!")
